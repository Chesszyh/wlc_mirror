# 交大课程评价系统开发者文档

> GENERATED BY CLAUDE CODE

基于 SJTU jCourse 项目的课程评价系统技术分析和镜像站开发指南。

## 项目概述

本项目是基于上海交通大学开发的两个开源项目：
- **后端**: [jcourse_api](https://github.com/dujiajun/jcourse_api) - Django REST Framework API 后端
- **前端**: [jcourse](https://github.com/dujiajun/jcourse) - Next.js React 前端

## 技术栈分析

### 后端技术栈 (wlc_backend)

#### 核心框架
- **Django 5.2.1** - Python Web 框架
- **Django REST Framework 3.15.2** - API 开发框架
- **PostgreSQL** - 主数据库
- **Redis** - 缓存和队列

#### 关键依赖
```
Authlib==1.3.2                 # OAuth 认证
django-cors-headers==4.6.0     # 跨域处理
django-filter==24.3            # API 过滤
django-import-export==4.2.0    # 数据导入导出
psycopg[binary]==3.2.3         # PostgreSQL 连接器
huey==2.5.2                    # 任务队列
jieba==0.42.1                  # 中文分词
pypinyin==0.53.0               # 拼音转换
qiniu==7.15.0                  # 七牛云存储
```

#### 项目结构
```
wlc_backend/
├── jcourse/                    # Django 主项目
│   ├── settings.py            # 项目配置
│   ├── urls.py                # 主 URL 配置
│   └── wsgi.py                # WSGI 应用
├── jcourse_api/               # 核心 API 应用
│   ├── models/                # 数据模型
│   ├── views/                 # API 视图
│   ├── serializers/           # 序列化器
│   ├── utils/                 # 工具函数
│   └── management/commands/   # 管理命令
├── oauth/                     # OAuth 认证模块
├── ad/                        # 广告推广模块
└── utils/                     # 通用工具
```

### 前端技术栈 (wlc_frontend)

#### 核心框架
- **Next.js 13.5.4** - React 元框架
- **React 18.2.0** - UI 库
- **TypeScript 5.4.4** - 类型支持
- **Ant Design 5.16.1** - UI 组件库

#### 关键依赖
```
ahooks==3.7.11                 # React hooks 库
axios==1.6.8                   # HTTP 客户端
swr==2.2.5                     # 数据获取
react-markdown==9.0.1          # Markdown 渲染
recharts==2.12.4               # 图表组件
```

#### 项目结构
```
wlc_frontend/
├── src/
│   ├── components/            # React 组件
│   ├── services/              # API 服务层
│   ├── lib/                   # 工具和类型定义
│   └── pages/                 # Next.js 页面
├── public/                    # 静态资源
└── next.config.js            # Next.js 配置
```

## 数据模型与数据库架构

### 核心数据模型

#### 1. 基础模型
- **Department**: 教学单位
- **Semester**: 学期信息
- **Category**: 课程类别

#### 2. 课程相关
- **Teacher**: 教师信息
- **Course**: 课程信息（课程号、名称、学分、主讲教师等）
- **FormerCode**: 课程旧课号映射

#### 3. 评价系统
- **Review**: 课程评价（评分、评论、学期等）
- **ReviewRevision**: 评价修订历史
- **ReviewReaction**: 评价点赞/点踩

#### 4. 用户相关
- **User**: Django 内置用户模型
- **EnrollCourse**: 用户选课记录
- **UserPoint**: 用户积分系统
- **Report**: 用户反馈

#### 5. 站点管理
- **Announcement**: 系统公告
- **ApiKey**: API 密钥管理
- **Notification**: 通知系统

### 数据库关系图
```
User (Django内置)
├── Review (一对多)
├── EnrollCourse (一对多)
├── UserPoint (一对多)
└── Report (一对多)

Course
├── Review (一对多)
├── EnrollCourse (一对多)
├── Teacher (主讲教师, 多对一)
├── Teacher (教师组, 多对多)
├── Category (多对多)
└── Department (多对一)

Review
├── ReviewRevision (一对多)
└── ReviewReaction (一对多)
```

## API 接口文档

### REST API 端点

#### 1. 课程相关 API
```
GET    /api/course/                    # 课程列表
GET    /api/course/{id}/               # 课程详情
GET    /api/course-filter/             # 课程筛选器
GET    /api/search/                    # 课程搜索
GET    /api/course-in-review/          # 待评价课程
POST   /api/course/{id}/notification_level/  # 课程关注设置
```

#### 2. 评价相关 API
```
GET    /api/review/                    # 评价列表
POST   /api/review/                    # 创建评价
GET    /api/review/{id}/               # 评价详情
PUT    /api/review/{id}/               # 更新评价
DELETE /api/review/{id}/               # 删除评价
GET    /api/review-filter/             # 评价筛选器
GET    /api/course/{id}/review/        # 课程评价列表
GET    /api/review/{id}/revision/      # 评价修订历史
POST   /api/review/{id}/reaction/      # 评价点赞/点踩
```

#### 3. 用户相关 API
```
GET    /api/me/                        # 当前用户信息
GET    /api/points/                    # 用户积分
GET    /api/lesson/                    # 选课记录
POST   /api/lesson/                    # 添加选课记录
```

#### 4. 系统相关 API
```
GET    /api/semester/                  # 学期列表
GET    /api/announcement/              # 公告列表
GET    /api/statistic/                 # 统计信息
GET    /api/common/                    # 通用信息
POST   /api/report/                    # 提交反馈
GET    /api/notification/              # 通知列表
```

#### 5. 认证相关 API
```
GET    /oauth/login/jaccount/          # jAccount 登录
GET    /oauth/callback/jaccount/       # jAccount 回调
POST   /oauth/logout/                  # 退出登录
POST   /oauth/send-email-code/         # 发送邮箱验证码
POST   /oauth/verify-email/            # 邮箱验证
```

#### 6. 推广相关 API
```
GET    /api/promotion/                 # 推广列表
GET    /api/promotion/{id}/            # 推广详情
```

### API 请求格式

#### 认证方式
- 使用 Cookie 会话认证
- CSRF Token 保护: `X-CSRFToken` 头部

#### 分页格式
```json
{
  "count": 100,
  "next": "http://example.com/api/course/?page=2",
  "previous": null,
  "results": [...]
}
```

#### 错误响应格式
```json
{
  "detail": "错误信息",
  "code": "error_code"
}
```

## 数据导出方案

### 1. Django 管理命令

#### 导出课程数据
```bash
python manage.py export_courses -o courses.csv
```
导出字段：课程号、课程名、主讲教师、课程ID

#### 自定义导出脚本
可创建自定义管理命令导出完整数据：

```python
# management/commands/export_all_data.py
from django.core.management.base import BaseCommand
from jcourse_api.models import *
import json

class Command(BaseCommand):
    def handle(self, *args, **options):
        # 导出所有相关数据为 JSON
        data = {
            'courses': list(Course.objects.all().values()),
            'reviews': list(Review.objects.all().values()),
            'teachers': list(Teacher.objects.all().values()),
            # ... 其他模型
        }
        with open('export_data.json', 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
```

### 2. 数据库直接导出

#### PostgreSQL 导出
```bash
# 导出整个数据库
pg_dump jcourse > jcourse_backup.sql

# 导出特定表
pg_dump -t jcourse_api_course -t jcourse_api_review jcourse > partial_backup.sql
```

#### 导出为 CSV
```sql
-- 导出课程数据
COPY (SELECT code, name, credit, main_teacher_id, department_id FROM jcourse_api_course) 
TO '/tmp/courses.csv' WITH CSV HEADER;

-- 导出评价数据
COPY (SELECT user_id, course_id, rating, comment, created_at FROM jcourse_api_review) 
TO '/tmp/reviews.csv' WITH CSV HEADER;
```

### 3. API 批量导出

#### 使用 API 分页获取所有数据
```python
import requests

def export_all_courses():
    courses = []
    page = 1
    while True:
        resp = requests.get(f'/api/course/?page={page}&size=100')
        data = resp.json()
        courses.extend(data['results'])
        if not data['next']:
            break
        page += 1
    return courses
```

## 镜像站开发建议

### 1. 架构设计

#### 静态站点生成
- 使用 **MkDocs** + **GitHub Pages**
- 定期（每月）从源系统获取数据
- 生成静态 HTML 页面

#### 数据同步策略
```python
# 数据同步脚本示例
def sync_data():
    # 1. 从 API 获取最新数据
    courses = fetch_all_courses()
    reviews = fetch_all_reviews()
    
    # 2. 转换为 Markdown 格式
    generate_course_pages(courses)
    generate_review_pages(reviews)
    
    # 3. 更新索引和导航
    update_navigation()
    
    # 4. 构建并部署
    build_and_deploy()
```

### 2. 数据结构设计

#### MkDocs 目录结构
```
docs/
├── index.md                   # 首页
├── courses/                   # 课程页面
│   ├── index.md              # 课程索引
│   ├── CS101.md              # 具体课程页面
│   └── ...
├── departments/               # 院系分类
├── teachers/                  # 教师页面
├── statistics/                # 统计信息
└── about.md                  # 关于页面
```

#### 页面模板
```markdown
# {{ course.code }} {{ course.name }}

**主讲教师**: {{ course.main_teacher.name }}
**开课单位**: {{ course.department.name }}
**学分**: {{ course.credit }}

## 课程评价

{% for review in course.reviews %}
### 评价 {{ forloop.counter }}
**评分**: {{ review.rating }}/5
**学期**: {{ review.semester.name }}

{{ review.comment }}

---
{% endfor %}
```

### 3. 自动化部署

#### GitHub Actions 工作流
```yaml
name: Update Mirror Site
on:
  schedule:
    - cron: '0 0 1 * *'  # 每月 1 号执行
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'
      - name: Sync Data
        run: |
          pip install -r requirements.txt
          python sync_data.py
      - name: Build MkDocs
        run: |
          pip install mkdocs mkdocs-material
          mkdocs build
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
```

### 4. 搜索功能实现

#### 客户端搜索
- 生成搜索索引 JSON 文件
- 使用 Lunr.js 或 Fuse.js 实现客户端搜索

#### 搜索索引生成
```python
def generate_search_index():
    index = []
    for course in courses:
        index.append({
            'id': course.id,
            'title': f"{course.code} {course.name}",
            'content': course.description,
            'url': f"/courses/{course.code}/",
            'category': course.department.name
        })
    
    with open('docs/search_index.json', 'w') as f:
        json.dump(index, f)
```

### 5. 性能优化

#### 图片和静态资源
- 压缩图片和 CSS/JS 文件
- 使用 CDN 加速静态资源

#### 缓存策略
- 浏览器缓存设置
- Service Worker 离线缓存

#### SEO 优化
- 生成 sitemap.xml
- 添加结构化数据标记
- 优化页面元数据

### 6. 监控和维护

#### 数据更新监控
- 检查源系统 API 可用性
- 监控数据同步状态
- 错误报告和日志记录

#### 内容质量控制
- 数据一致性检查
- 内容审核机制
- 用户反馈收集

## 开发环境设置

### 后端开发环境

```bash
# 1. 克隆代码
git clone <backend-repo>
cd wlc_backend

# 2. 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate   # Windows

# 3. 安装依赖
pip install -r requirements.txt

# 4. 配置环境变量
export POSTGRES_PASSWORD=your_password
export POSTGRES_HOST=localhost
export JACCOUNT_CLIENT_ID=your_client_id
export JACCOUNT_CLIENT_SECRET=your_client_secret

# 5. 初始化数据库
python manage.py migrate
python manage.py createsuperuser

# 6. 运行开发服务器
python manage.py runserver
```

### 前端开发环境

```bash
# 1. 克隆代码
git clone <frontend-repo>
cd wlc_frontend

# 2. 安装依赖
yarn install

# 3. 配置环境变量
echo "REMOTE_URL=http://localhost:8000" > .env.local

# 4. 运行开发服务器
yarn dev
```

## 总结

基于对交大两个项目的深入分析，我们了解了：

1. **技术栈**: Django + DRF 后端，Next.js + React 前端
2. **数据模型**: 完整的课程评价系统数据结构
3. **API接口**: RESTful API 设计，支持完整的 CRUD 操作
4. **数据导出**: 多种数据导出方案可选

镜像站开发建议使用 MkDocs 生成静态站点，通过定期同步数据保持内容更新，利用 GitHub Actions 实现自动化部署，为用户提供稳定、快速的课程评价信息查询服务。