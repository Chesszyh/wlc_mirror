# 1.tongji.icu 课程评价系统数据集成设计文档

## 1. 项目概述

本文档描述了将 1.tongji.icu 课程评价系统的数据集成到现有选课模拟系统数据库的设计方案。目标是在保持现有系统数据结构完整性的基础上，添加课程评价功能，实现数据的有机融合。

## 2. 现有系统分析

### 2.1 现有数据库结构
现有选课模拟系统包含以下核心表：
- `coursedetail`: 课程详情表，包含课程基本信息
- `teacher`: 教师表，关联到具体的教学班
- `coursenature`: 课程性质表
- `campus`, `faculty`, `calendar` 等辅助表

### 2.2 关键字段分析
- `coursedetail.code`: 课程代码，为主要匹配字段
- `coursedetail.courseCode`: 课程编号
- `teacher.teacherName`: 教师姓名，用于精确匹配

## 3. 1.tongji.icu API数据分析

### 3.1 课程API (`api-course.json`)
主要字段：
- `id`: 课程在1.tongji.icu系统中的ID
- `code`: 课程代码（如"00200901"）
- `name`: 课程名称
- `teacher`: 教师姓名
- `department`: 开课院系
- `categories`: 课程分类（数组）
- `rating`: 评分统计信息
  - `count`: 评价数量
  - `avg`: 平均评分
- `credit`: 学分

### 3.2 评价API (`api-review.json`)
主要字段：
- `id`: 评价ID
- `course`: 课程信息对象
  - `id`: 课程ID
  - `code`: 课程代码
  - `name`: 课程名称
  - `teacher`: 教师姓名
- `rating`: 评分(1-5)
- `comment`: 评价内容
- `semester`: 学期
- `score`: 成绩等级
- `created_at`, `modified_at`: 时间戳
- `reactions`: 点赞/点踩信息

## 4. 数据匹配策略

### 4.1 课程代码匹配规则
1. **直接匹配**: `api_course.code` 直接对应 `coursedetail.code`
2. **基础课程匹配**:
   - 解析课程代码，如"00200902"可能表示课程"002009"的第2个教学班
   - 提取基础课程代码进行匹配
3. **模糊匹配**: 基于课程名称和教师姓名的组合匹配

### 4.2 匹配置信度分级
- **HIGH**: 课程代码+教师姓名完全匹配
- **MEDIUM**: 基础课程代码+教师姓名匹配
- **LOW**: 仅课程名称匹配
- **MANUAL**: 需要人工验证的匹配

## 5. 数据模型设计

### 5.1 新增表结构

#### 5.1.1 课程评价表 (`course_review`)
存储来自1.tongji.icu的原始评价数据：
- 主键：自增ID
- 唯一约束：`tongji_icu_id`
- 关键索引：课程代码、教师姓名、评分、学期

#### 5.1.2 课程评价汇总表 (`course_review_summary`)
对评价数据进行统计汇总：
- 按课程代码+教师姓名聚合
- 包含总评价数、平均评分、评分分布等统计信息

#### 5.1.3 课程匹配映射表 (`course_mapping`)
记录1.tongji.icu课程与本系统课程的映射关系：
- 支持多种匹配方法
- 包含匹配置信度和验证状态
- 支持人工干预和修正

#### 5.1.4 数据同步日志表 (`sync_log`)
记录数据同步过程：
- 支持全量和增量同步
- 详细的同步统计信息
- 错误日志和调试信息

### 5.2 现有表结构扩展
为`coursedetail`表添加评价相关字段：
- `has_reviews`: 是否有评价数据
- `review_count`: 评价数量
- `avg_rating`: 平均评分
- `last_review_sync`: 最后同步时间

## 6. 数据同步策略

### 6.1 同步流程
1. **课程数据同步**: 从course API获取课程基本信息
2. **评价数据同步**: 从review API获取评价详情
3. **数据匹配**: 执行课程匹配算法
4. **数据聚合**: 生成评价汇总统计
5. **增量更新**: 更新现有课程表的评价字段

### 6.2 增量同步机制
- 基于`modified_at`字段识别更新的评价
- 基于`sync_time`字段避免重复同步
- 支持断点续传和错误重试

### 6.3 数据质量保证
- 数据去重和一致性检查
- 异常数据识别和处理
- 人工审核流程

## 7. 查询优化

### 7.1 索引策略
- 复合索引：课程代码+教师姓名
- 时间索引：评价时间、同步时间
- 评分索引：支持按评分排序查询

### 7.2 视图设计
创建`v_course_with_reviews`视图，整合课程信息和评价统计。

## 8. 实施计划

### 8.1 Phase 1: 数据库结构创建
- 执行DDL脚本创建新表
- 添加必要的索引和约束

### 8.2 Phase 2: 数据匹配与导入
- 实现课程匹配算法
- 批量导入历史数据
- 验证数据质量

### 8.3 Phase 3: 增量同步实现
- 开发同步脚本
- 实现错误处理和重试机制
- 部署定时任务

## 9. 风险与挑战

### 9.1 数据一致性
- 课程代码格式可能不统一
- 教师姓名可能存在变体
- 需要建立完善的匹配机制

### 9.2 性能考虑
- 大量评价数据的存储和查询优化
- 同步过程的性能优化
- 索引策略的持续优化

### 9.3 维护成本
- 匹配规则的持续优化
- 数据质量的持续监控
- 同步脚本的维护更新

## 10. 总结

本设计方案在保持现有系统稳定性的基础上，有机集成了课程评价功能。通过合理的数据模型设计、智能的匹配策略和完善的同步机制，实现了两个系统数据的有效融合，为后续的镜像站建设和功能扩展奠定了坚实的基础。